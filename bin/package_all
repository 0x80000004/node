#!/bin/bash

###########################################################################
# Packaging script which creates all packages (Debian/Ubuntu/Linux/OSX/Windows)
#
# To package a build, simple execute:
#> bin/package_all <version> <os>

# Usage:
#> bin/package_all <version> <os>

set -e

bin/travis_scripts/ensure_xgo.sh

source bin/helpers/output.sh

VERSION=$1
if [ -z "$VERSION" ]; then
    print_error "Missing version!"
    exit 1
fi

OS=$2
if [[ ! "$OS" =~ ^(linux|darwin|windows)$ ]]; then
    print_error "Missing OS! Should be: linux, darwin or windows"
    exit 1
fi

if [ "$OS" == "windows" ]; then
    SUFFIX=".exe"
fi

DIR_BUILD="build/package"

printf "Building version '$VERSION' for '$OS' packages to directory '$DIR_BUILD' ..\n"
rm -rf ${DIR_BUILD}
mkdir -p ${DIR_BUILD}

bin/server_build_xgo $OS/amd64
bin/client_build_xgo $OS/amd64

BINARY=build/server/mysterium_server_${OS}_amd64$SUFFIX bin/server_package_standalone $OS
BINARY=build/client/mysterium_client_${OS}_amd64$SUFFIX bin/client_package_standalone $OS

if [ "$OS" == "linux" ]; then
    bin/builder_run BINARY=build/server/mysterium_server_linux_amd64 bin/server_package_debian ${VERSION} amd64
    bin/builder_run BINARY=build/client/mysterium_client_linux_amd64 bin/client_package_debian ${VERSION} amd64
fi

print_success "All packages for '$OS' successfully packaged to directory '$DIR_BUILD'!"
exit 0
