#!/bin/bash

GOOS=linux GOARCH=amd64 bin/server_build
if [ $? -ne 0 ] ; then
    exit 1
fi

SSH_SERVER=root@server.mysterium.localhost
SSH_SERVER_DIR=mysterium/shared

printf "\n\nStopping application at '$SSH_SERVER':\n" \
    && ssh $SSH_SERVER 'sudo killall mysterium_server || true' \
    && ssh $SSH_SERVER 'sudo killall openvpn || true' \
&& printf "\n\nDeploying application:\n" \
    && ssh $SSH_SERVER "mkdir -pv $SSH_SERVER_DIR" \
    && scp mysterium_server \
        bin/shared/server.conf bin/shared/secret.key \
        $SSH_SERVER:$SSH_SERVER_DIR/ \
&& printf "\n\nStarting application:\n" \
    && ssh $SSH_SERVER "cd $SSH_SERVER_DIR && sudo ./mysterium_server"

exit 0